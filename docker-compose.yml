# =============================================================================
# WSO2 API Manager 4.5.0 - Entorno APIOps
# =============================================================================
#
# Sistema de integración WSO2 + GitHub para gestión de APIs con Git como
# source of truth y aprobaciones via Helix ITSM.
#
# INICIO RÁPIDO:
#   1. Copiar .env.example a .env y configurar GITHUB_TOKEN
#   2. docker compose up -d
#   3. Esperar ~3 minutos a que WSO2 esté healthy
#   4. ./scripts/setup-all.sh (primera vez)
#
# COMANDOS ÚTILES:
#   Ver estado:    docker compose ps
#   Ver logs:      docker compose logs -f [servicio]
#   Reiniciar:     docker compose restart [servicio]
#   Reset total:   docker compose down -v && docker compose up -d
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # WSO2 API Manager
  # ---------------------------------------------------------------------------
  # Portal de gestión de APIs con componente UATRegistration integrado
  # para registro automatizado en entornos UAT via GitHub Actions.
  #
  wso2-apim:
    image: wso2/wso2am:4.5.0
    container_name: wso2-apim
    hostname: wso2-apim
    labels:
      com.apiops.service: "wso2-apim"
      com.apiops.description: "WSO2 API Manager with APIOps integration"
      com.apiops.version: "4.5.0"
    ports:
      - "9443:9443"   # Publisher & Carbon Admin (HTTPS)
      - "9763:9763"   # DevPortal (HTTP)
      - "8243:8243"   # Gateway (HTTPS)
      - "8280:8280"   # Gateway (HTTP)
    volumes:
      # --- Persistencia ---
      - wso2-apim-data:/home/wso2carbon/wso2am-4.5.0/repository/database
      - wso2-apim-registry:/home/wso2carbon/wso2am-4.5.0/repository/resources
      - wso2-apim-logs:/home/wso2carbon/wso2am-4.5.0/repository/logs
      # --- APIOps Customizations ---
      - ./lifecycle/APILifeCycle.xml:/home/wso2carbon/wso2am-4.5.0/repository/resources/lifecycles/APILifeCycle.xml:ro
      - ./publisher-dropin:/home/wso2carbon/wso2am-4.5.0/repository/deployment/server/webapps/publisher/site/public/dist:ro
      - ./publisher-dropin-pages/index.jsp:/home/wso2carbon/wso2am-4.5.0/repository/deployment/server/webapps/publisher/site/public/pages/index.jsp:ro
      - ./publisher-config/apiops-config.js:/home/wso2carbon/wso2am-4.5.0/repository/deployment/server/webapps/publisher/site/public/conf/apiops-config.js:ro
    environment:
      - TZ=Europe/Madrid
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:9443/carbon/admin/login.jsp"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # GitHub Actions Self-Hosted Runner
  # ---------------------------------------------------------------------------
  # Runner dockerizado que ejecuta workflows de apim-exporter-wso2.
  # Tiene acceso a WSO2 via la red de Docker (wso2-apim:9443).
  #
  # CONFIGURACIÓN REQUERIDA (en .env):
  #   GITHUB_TOKEN - Personal Access Token con scope 'repo'
  #   GITHUB_OWNER - Owner del repositorio (ej: tu-org)
  #   GITHUB_REPO  - Nombre del repo apim-exporter-wso2
  #
  github-runner:
    build:
      context: ./github-runner
      dockerfile: Dockerfile
    container_name: github-runner
    labels:
      com.apiops.service: "github-runner"
      com.apiops.description: "GitHub Actions self-hosted runner for APIOps"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_OWNER=${GITHUB_OWNER}
      - GITHUB_REPO=${GITHUB_REPO}
      - RUNNER_NAME=apiops-runner-docker
      - RUNNER_LABELS=self-hosted,linux,x64,apiops
      - WSO2_BASE_URL=https://wso2-apim:9443
    depends_on:
      wso2-apim:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

# -----------------------------------------------------------------------------
# VOLÚMENES
# -----------------------------------------------------------------------------
# Datos persistentes de WSO2. Para reset completo: docker compose down -v
#
volumes:
  wso2-apim-data:
    name: wso2-apim-data
    labels:
      com.apiops.volume: "database"
  wso2-apim-registry:
    name: wso2-apim-registry
    labels:
      com.apiops.volume: "registry"
  wso2-apim-logs:
    name: wso2-apim-logs
    labels:
      com.apiops.volume: "logs"
