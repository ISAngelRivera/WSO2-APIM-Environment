# WSO2 API Manager 4.5.0 - Entorno de Desarrollo APIOps
#
# Uso:
#   Primera vez:     docker-compose up -d && ./scripts/wait-for-apim.sh && ./scripts/setup-all.sh
#   Siguientes:      docker-compose up -d
#   Reset completo:  docker-compose down -v && docker-compose up -d && ./scripts/setup-all.sh

services:
  wso2-apim:
    image: wso2/wso2am:4.5.0
    container_name: wso2-apim
    hostname: wso2-apim
    ports:
      # Portal de Publisher
      - "9443:9443"
      # Portal de DevPortal
      - "9763:9763"
      # Gateway HTTPS
      - "8243:8243"
      # Gateway HTTP
      - "8280:8280"
    volumes:
      # Persistencia de datos
      - wso2-apim-data:/home/wso2carbon/wso2am-4.5.0/repository/database
      # Persistencia de configuración del registry (lifecycles)
      - wso2-apim-registry:/home/wso2carbon/wso2am-4.5.0/repository/resources
      # Logs
      - wso2-apim-logs:/home/wso2carbon/wso2am-4.5.0/repository/logs
      # Archivo de lifecycle customizado (montado como solo lectura)
      - ./lifecycle/APILifeCycle.xml:/home/wso2carbon/wso2am-4.5.0/repository/resources/lifecycles/APILifeCycle.xml:ro
      # APIOps: Publisher con componente UATRegistration nativo (dropin React)
      - ./publisher-dropin:/home/wso2carbon/wso2am-4.5.0/repository/deployment/server/webapps/publisher/site/public/dist:ro
      # APIOps: index.jsp con el hash correcto del bundle
      - ./publisher-dropin-pages/index.jsp:/home/wso2carbon/wso2am-4.5.0/repository/deployment/server/webapps/publisher/site/public/pages/index.jsp:ro
      # APIOps: Configuración externa (GitHub token, feature flags)
      - ./publisher-config/apiops-config.js:/home/wso2carbon/wso2am-4.5.0/repository/deployment/server/webapps/publisher/site/public/conf/apiops-config.js:ro
    environment:
      - TZ=Europe/Madrid
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:9443/carbon/admin/login.jsp"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped

  # ============================================
  # GitHub Actions Self-Hosted Runner
  # ============================================
  # Runner dockerizado para ejecutar workflows de APIOps
  # Puede acceder a WSO2 via la red de Docker (wso2-apim:9443)
  #
  # IMPORTANTE: Antes de iniciar, configurar las variables en .env:
  #   GITHUB_TOKEN=ghp_xxx...
  #   GITHUB_OWNER=ISAngelRivera
  #   GITHUB_REPO=WSO2-Processor
  #
  github-runner:
    build:
      context: ./github-runner
      dockerfile: Dockerfile
    container_name: github-runner
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_OWNER=${GITHUB_OWNER:-ISAngelRivera}
      - GITHUB_REPO=${GITHUB_REPO:-WSO2-Processor}
      - RUNNER_NAME=apiops-runner-docker
      - RUNNER_LABELS=self-hosted,linux,x64,apiops
      # WSO2 accesible desde el runner via Docker network
      - WSO2_BASE_URL=https://wso2-apim:9443
    depends_on:
      wso2-apim:
        condition: service_healthy
    restart: unless-stopped
    # El runner necesita acceso a Docker para algunos workflows (opcional)
    # volumes:
    #   - /var/run/docker.sock:/var/run/docker.sock

volumes:
  wso2-apim-data:
    name: wso2-apim-data
  wso2-apim-registry:
    name: wso2-apim-registry
  wso2-apim-logs:
    name: wso2-apim-logs
